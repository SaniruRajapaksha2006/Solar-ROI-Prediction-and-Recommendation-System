<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>SolarGrid Intelligence</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    /* ── Design tokens ─────────────────────────────────────────────────── */
    :root {
      --bg:         #0a0e1a;
      --surface:    #111827;
      --surface2:   #1c2539;
      --border:     #1f2d45;
      --text:       #e2e8f0;
      --muted:      #64748b;
      --accent:     #00d4ff;
      --accent2:    #7c3aed;
      --green:      #10b981;
      --amber:      #f59e0b;
      --red:        #ef4444;
      --mono:       'Space Mono', monospace;
      --sans:       'DM Sans', sans-serif;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    html, body { height: 100%; background: var(--bg); color: var(--text); font-family: var(--sans); }

    /* ── Noise texture overlay ─────────────────────────────────────────── */
    body::before {
      content: '';
      position: fixed; inset: 0; z-index: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none;
    }

    #app { position: relative; z-index: 1; min-height: 100vh; }

    /* ── Typography ────────────────────────────────────────────────────── */
    .mono  { font-family: var(--mono); }
    .label { font-size: 10px; letter-spacing: 0.15em; text-transform: uppercase; color: var(--muted); font-family: var(--mono); }

    /* ── Layout ────────────────────────────────────────────────────────── */
    .container { max-width: 1280px; margin: 0 auto; padding: 0 24px; }

    /* ── Topbar ─────────────────────────────────────────────────────────── */
    .topbar {
      border-bottom: 1px solid var(--border);
      padding: 18px 32px;
      display: flex;
      align-items: center;
      gap: 16px;
      background: rgba(10,14,26,0.85);
      backdrop-filter: blur(12px);
      position: sticky; top: 0; z-index: 100;
    }

    .topbar-logo {
      font-family: var(--mono);
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: var(--accent);
    }
    .topbar-logo span { color: var(--text); }

    .topbar-tag {
      font-size: 10px;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--muted);
      border: 1px solid var(--border);
      padding: 3px 8px;
      border-radius: 4px;
      font-family: var(--mono);
    }

    .topbar-dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 10px var(--green);
      animation: pulse 2s infinite;
      margin-left: auto;
    }
    @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

    /* ── Hero ───────────────────────────────────────────────────────────── */
    .hero {
      padding: 72px 32px 56px;
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 80px;
      align-items: start;
      max-width: 1280px;
      margin: 0 auto;
    }

    .hero-eyebrow {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 12px;
    }
    .hero-eyebrow::before {
      content: '';
      display: block;
      width: 32px; height: 1px;
      background: var(--accent);
    }

    .hero-title {
      font-size: clamp(36px, 4vw, 56px);
      font-weight: 300;
      line-height: 1.1;
      letter-spacing: -0.02em;
      margin-bottom: 24px;
    }
    .hero-title strong { font-weight: 600; }
    .hero-title .accent { color: var(--accent); }

    .hero-desc {
      color: var(--muted);
      font-size: 15px;
      line-height: 1.7;
      max-width: 520px;
    }

    /* ── Form card ──────────────────────────────────────────────────────── */
    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 32px;
      position: relative;
      overflow: hidden;
    }
    .form-card::before {
      content: '';
      position: absolute;
      top: -1px; left: 24px; right: 24px; height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent), transparent);
    }

    .form-section-label {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--accent);
      margin-bottom: 16px;
      margin-top: 24px;
    }
    .form-section-label:first-child { margin-top: 0; }

    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

    .field-wrap { display: flex; flex-direction: column; gap: 8px; }

    .field-label {
      font-size: 12px;
      color: var(--muted);
      font-family: var(--mono);
    }

    .field-input {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 14px;
      font-family: var(--mono);
      padding: 11px 14px;
      transition: border-color 0.2s, box-shadow 0.2s;
      width: 100%;
    }
    .field-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,212,255,0.08);
    }

    .divider {
      height: 1px;
      background: var(--border);
      margin: 24px 0;
    }

    .btn-assess {
      width: 100%;
      margin-top: 8px;
      padding: 16px;
      background: var(--accent);
      color: #0a0e1a;
      border: none;
      border-radius: 10px;
      font-family: var(--mono);
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.15s, box-shadow 0.15s, opacity 0.15s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn-assess:hover:not(:disabled) {
      box-shadow: 0 0 30px rgba(0,212,255,0.35);
      transform: translateY(-1px);
    }
    .btn-assess:disabled { opacity: 0.5; cursor: not-allowed; }

    .error-banner {
      background: rgba(239,68,68,0.1);
      border: 1px solid rgba(239,68,68,0.3);
      border-radius: 8px;
      padding: 12px 14px;
      font-size: 13px;
      color: #fca5a5;
      margin-top: 12px;
      font-family: var(--mono);
    }

    /* ── Spinner ────────────────────────────────────────────────────────── */
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(10,14,26,0.3);
      border-top-color: #0a0e1a;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ── Results page ───────────────────────────────────────────────────── */
    .results-header {
      padding: 32px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 24px;
      max-width: 1280px; margin: 0 auto;
    }

    .back-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--muted);
      border-radius: 8px;
      padding: 8px 14px;
      font-family: var(--mono);
      font-size: 12px;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
      display: flex; align-items: center; gap: 8px;
    }
    .back-btn:hover { color: var(--text); border-color: var(--accent); }

    .results-title { font-size: 26px; font-weight: 300; letter-spacing: -0.02em; }
    .results-title strong { font-weight: 600; }
    .results-meta { margin-left: auto; font-family: var(--mono); font-size: 11px; color: var(--muted); }

    /* ── Stats row ──────────────────────────────────────────────────────── */
    .stats-row {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      padding: 24px 32px;
      max-width: 1280px; margin: 0 auto;
    }

    .stat-tile {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
    }
    .stat-tile::after {
      content: '';
      position: absolute;
      bottom: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, var(--accent2), var(--accent));
    }

    .stat-tile-val {
      font-family: var(--mono);
      font-size: 28px;
      font-weight: 700;
      color: var(--accent);
      line-height: 1;
    }
    .stat-tile-val.green { color: var(--green); }
    .stat-tile-val.amber { color: var(--amber); }
    .stat-tile-val.red   { color: var(--red); }

    .stat-tile-lbl {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
      font-family: var(--mono);
      letter-spacing: 0.05em;
    }

    /* ── Main results grid ──────────────────────────────────────────────── */
    .results-grid {
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 24px;
      padding: 0 32px 48px;
      max-width: 1280px; margin: 0 auto;
    }

    /* ── Map ────────────────────────────────────────────────────────────── */
    .map-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 24px;
    }
    .map-card-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
    }
    .map-card-title { font-size: 13px; font-family: var(--mono); }
    .map-legend {
      margin-left: auto;
      display: flex; gap: 16px; align-items: center;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 11px; color: var(--muted); font-family: var(--mono); }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    #resultsMap { height: 380px; }

    /* ── Transformer list ───────────────────────────────────────────────── */
    .tf-section-title {
      font-family: var(--mono);
      font-size: 11px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    .tf-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 18px 20px;
      margin-bottom: 10px;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
      display: grid;
      grid-template-columns: 42px 1fr auto;
      gap: 16px;
      align-items: center;
    }
    .tf-card:hover { border-color: var(--accent); background: var(--surface2); }
    .tf-card.active { border-color: var(--accent); }

    .tf-rank {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      text-align: center;
    }
    .tf-rank-num { font-size: 22px; font-weight: 700; color: var(--text); line-height: 1; }

    .tf-code { font-family: var(--mono); font-size: 15px; font-weight: 700; color: var(--text); }
    .tf-cluster { font-size: 12px; color: var(--muted); margin-top: 4px; }

    .tf-metrics {
      display: flex; gap: 20px; margin-top: 12px;
    }
    .tf-metric { font-size: 12px; }
    .tf-metric-lbl { color: var(--muted); font-family: var(--mono); font-size: 10px; }
    .tf-metric-val { font-weight: 600; margin-top: 2px; }

    .tf-badge {
      display: flex; flex-direction: column; align-items: center; gap: 6px;
    }
    .score-ring {
      width: 52px; height: 52px; position: relative;
    }
    .score-ring svg { transform: rotate(-90deg); }
    .score-ring-val {
      position: absolute; inset: 0;
      display: flex; align-items: center; justify-content: center;
      font-family: var(--mono); font-size: 13px; font-weight: 700;
    }
    .score-label { font-family: var(--mono); font-size: 9px; letter-spacing: 0.1em; }

    .dist-pill {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 2px 8px;
      font-family: var(--mono);
      font-size: 10px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* ── Detail panel ───────────────────────────────────────────────────── */
    .detail-panel {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: sticky;
      top: 80px;
      max-height: calc(100vh - 100px);
      overflow-y: auto;
    }

    .detail-empty {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      height: 200px; gap: 12px;
    }
    .detail-empty-icon { font-size: 32px; opacity: 0.3; }
    .detail-empty-txt { font-size: 13px; color: var(--muted); text-align: center; }

    .detail-code { font-family: var(--mono); font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .detail-cluster { font-size: 12px; color: var(--muted); margin-bottom: 24px; }

    .detail-score-big {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
      margin-bottom: 16px;
    }
    .detail-score-val {
      font-family: var(--mono);
      font-size: 40px;
      font-weight: 700;
      line-height: 1;
    }
    .detail-score-lbl { font-size: 11px; color: var(--muted); margin-top: 6px; font-family: var(--mono); }

    .detail-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 16px;
    }

    .detail-metric {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
    }
    .detail-metric-lbl { font-size: 10px; color: var(--muted); font-family: var(--mono); letter-spacing: 0.08em; margin-bottom: 6px; }
    .detail-metric-val { font-family: var(--mono); font-size: 16px; font-weight: 700; }

    /* Progress bar */
    .util-bar-wrap { margin-bottom: 16px; }
    .util-bar-header { display: flex; justify-content: space-between; font-size: 11px; font-family: var(--mono); color: var(--muted); margin-bottom: 6px; }
    .util-bar-track {
      height: 6px; background: var(--surface2); border-radius: 3px; overflow: hidden;
    }
    .util-bar-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

    .score-sub-grid {
      display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 16px;
    }
    .score-sub {
      background: var(--surface2); border: 1px solid var(--border); border-radius: 8px;
      padding: 10px; text-align: center;
    }
    .score-sub-lbl { font-size: 9px; color: var(--muted); font-family: var(--mono); letter-spacing: 0.08em; }
    .score-sub-val { font-family: var(--mono); font-size: 15px; font-weight: 700; margin-top: 4px; }

    .flag-badge {
      border-radius: 6px; padding: 10px 12px; font-size: 12px; font-family: var(--mono);
      display: flex; align-items: center; gap: 8px; margin-bottom: 8px;
    }
    .flag-red   { background: rgba(239,68,68,0.1);  border: 1px solid rgba(239,68,68,0.25);  color: #fca5a5; }
    .flag-green { background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.25); color: #6ee7b7; }

    .rec-box {
      background: rgba(0,212,255,0.05);
      border: 1px solid rgba(0,212,255,0.15);
      border-radius: 10px;
      padding: 14px;
      font-size: 12px;
      line-height: 1.6;
      color: #94a3b8;
    }

    /* ── Chart canvas ───────────────────────────────────────────────────── */
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 24px;
    }
    .chart-card-title { font-family: var(--mono); font-size: 11px; letter-spacing: 0.12em; color: var(--muted); text-transform: uppercase; margin-bottom: 16px; }

    /* ── Responsive ─────────────────────────────────────────────────────── */
    @media (max-width: 900px) {
      .hero { grid-template-columns: 1fr; gap: 40px; }
      .stats-row { grid-template-columns: repeat(3, 1fr); }
      .results-grid { grid-template-columns: 1fr; }
    }
    @media (max-width: 600px) {
      .stats-row { grid-template-columns: 1fr 1fr; }
      .tf-card { grid-template-columns: 32px 1fr auto; }
    }
  </style>
</head>
<body>
<div id="app"></div>

<script>
// ── Constants ──────────────────────────────────────────────────────────────
const API = 'http://localhost:5000';

// ── App State ──────────────────────────────────────────────────────────────
const state = {
  page: 'home',
  lat: 6.849,
  lon: 79.9247,
  solarKw: 5.0,
  radius: 1000,
  loading: false,
  error: null,
  results: null,
  selected: null,
  map: null,
};

function setState(patch) {
  Object.assign(state, patch);
  render();
}

// ── API ─────────────────────────────────────────────────────────────────────
async function runAssessment() {
  if (state.loading) return;
  setState({ loading: true, error: null });

  try {
    const res = await fetch(`${API}/api/assess`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        latitude: state.lat,
        longitude: state.lon,
        solarCapacity: state.solarKw,
        searchRadius: state.radius,
      }),
    });

    const data = await res.json();

    if (!res.ok) throw new Error(data.error || `HTTP ${res.status}`);

    setState({ results: data, page: 'results', loading: false, selected: data.transformers[0] });
    requestAnimationFrame(() => initMap());
  } catch (err) {
    setState({ error: err.message, loading: false });
  }
}

// ── Colour helpers ──────────────────────────────────────────────────────────
function scoreColor(s) {
  if (s >= 80) return '#10b981';
  if (s >= 60) return '#00d4ff';
  if (s >= 40) return '#f59e0b';
  return '#ef4444';
}

function utilColor(u) {
  if (u <= 70) return '#10b981';
  if (u <= 85) return '#f59e0b';
  return '#ef4444';
}

// ── Map ─────────────────────────────────────────────────────────────────────
function initMap() {
  if (state.map) { state.map.remove(); state.map = null; }
  const { results, lat, lon } = state;
  const map = L.map('resultsMap', { zoomControl: true }).setView([lat, lon], 14);
  state.map = map;

  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution: '© OpenStreetMap, © CARTO',
    maxZoom: 19,
  }).addTo(map);

  // User location
  L.circleMarker([lat, lon], {
    radius: 10, fillColor: '#00d4ff', color: '#0a0e1a',
    weight: 3, opacity: 1, fillOpacity: 0.9,
  }).addTo(map).bindPopup('<b style="font-family:monospace">Your Location</b>');

  const markers = [];
  results.transformers.forEach(tf => {
    const col = scoreColor(tf.score);
    const m = L.circleMarker([tf.latitude, tf.longitude], {
      radius: 9, fillColor: col, color: '#0a0e1a',
      weight: 2, opacity: 1, fillOpacity: 0.85,
    }).addTo(map).bindPopup(`
      <div style="font-family:monospace;font-size:12px;line-height:1.6">
        <b>${tf.code}</b><br>
        Score: ${tf.score.toFixed(1)}/100<br>
        Distance: ${tf.distance.toFixed(0)} m<br>
        Util after: ${tf.utilizationAfter.toFixed(1)}%<br>
        ${tf.canSupport ? '✅ Supported' : '❌ Not supported'}
      </div>
    `);
    m.on('click', () => setState({ selected: tf }));
    markers.push(m);
  });

  if (markers.length > 0) {
    const group = L.featureGroup(markers);
    map.fitBounds(group.getBounds().pad(0.15));
  }
}

// ── SVG Score Ring ──────────────────────────────────────────────────────────
function scoreRing(score) {
  const col = scoreColor(score);
  const r = 20; const circ = 2 * Math.PI * r;
  const dash = (score / 100) * circ;
  return `
    <div class="score-ring">
      <svg viewBox="0 0 52 52" width="52" height="52">
        <circle cx="26" cy="26" r="${r}" fill="none" stroke="#1c2539" stroke-width="5"/>
        <circle cx="26" cy="26" r="${r}" fill="none" stroke="${col}" stroke-width="5"
          stroke-dasharray="${dash} ${circ - dash}" stroke-linecap="round"/>
      </svg>
      <div class="score-ring-val" style="color:${col}">${Math.round(score)}</div>
    </div>
  `;
}

// ── Utilisation bar ─────────────────────────────────────────────────────────
function utilBar(label, value) {
  const col = utilColor(value);
  return `
    <div class="util-bar-wrap">
      <div class="util-bar-header"><span>${label}</span><span style="color:${col}">${value.toFixed(1)}%</span></div>
      <div class="util-bar-track"><div class="util-bar-fill" style="width:${Math.min(value,100)}%;background:${col}"></div></div>
    </div>
  `;
}

// ── Home page ──────────────────────────────────────────────────────────────
function renderHome() {
  return `
    <div class="topbar">
      <div class="topbar-logo">Solar<span>Grid</span></div>
      <div class="topbar-tag">v2.0 · Intelligence System</div>
      <div class="topbar-dot"></div>
    </div>

    <div class="hero">
      <div>
        <div class="hero-eyebrow">Geospatial AI Assessment</div>
        <h1 class="hero-title">
          <strong>Transformer</strong><br>
          <span class="accent">Suitability</span><br>
          Intelligence
        </h1>
        <p class="hero-desc">
          AI-powered analysis that maps nearby grid transformers, estimates headroom capacity,
          predicts curtailment risk, and ranks your best solar connection options —
          with explainable recommendations.
        </p>

        <div style="display:flex;gap:24px;margin-top:40px;flex-wrap:wrap">
          ${['Geospatial Proximity', 'Headroom Analysis', 'ML Overload Prediction', 'Curtailment Risk', 'Explainable AI'].map(f => `
            <div style="display:flex;align-items:center;gap:8px">
              <div style="width:6px;height:6px;border-radius:50%;background:var(--accent)"></div>
              <span style="font-size:12px;color:var(--muted);font-family:var(--mono)">${f}</span>
            </div>
          `).join('')}
        </div>
      </div>

      <div class="form-card">
        <div class="form-section-label">Location Coordinates</div>
        <div class="form-grid">
          <div class="field-wrap">
            <div class="field-label">Latitude</div>
            <input class="field-input" type="number" step="0.0001"
              value="${state.lat}"
              onchange="setState({lat: parseFloat(this.value)})"
              placeholder="6.849" />
          </div>
          <div class="field-wrap">
            <div class="field-label">Longitude</div>
            <input class="field-input" type="number" step="0.0001"
              value="${state.lon}"
              onchange="setState({lon: parseFloat(this.value)})"
              placeholder="79.9247" />
          </div>
        </div>

        <div class="divider"></div>
        <div class="form-section-label">Solar Installation</div>
        <div class="form-grid">
          <div class="field-wrap">
            <div class="field-label">Capacity (kW)</div>
            <input class="field-input" type="number" step="0.5" min="1" max="200"
              value="${state.solarKw}"
              onchange="setState({solarKw: parseFloat(this.value)})" />
          </div>
          <div class="field-wrap">
            <div class="field-label">Search Radius (m)</div>
            <input class="field-input" type="number" step="100" min="100" max="5000"
              value="${state.radius}"
              onchange="setState({radius: parseFloat(this.value)})" />
          </div>
        </div>

        ${state.error ? `<div class="error-banner">⚠ ${state.error}</div>` : ''}

        <button class="btn-assess" onclick="runAssessment()" ${state.loading ? 'disabled' : ''}>
          ${state.loading
            ? `<div class="spinner"></div> ANALYSING…`
            : `▶ &nbsp;RUN ASSESSMENT`}
        </button>
      </div>
    </div>
  `;
}

// ── Results page ───────────────────────────────────────────────────────────
function renderResults() {
  const { results, selected } = state;
  if (!results) return '';

  const supported = results.transformers.filter(t => t.canSupport).length;
  const topScore  = results.transformers[0].score;

  return `
    <div class="topbar">
      <div class="topbar-logo">Solar<span>Grid</span></div>
      <div class="topbar-tag">Assessment Results</div>
      <div class="topbar-dot"></div>
    </div>

    <div class="results-header">
      <button class="back-btn" onclick="setState({page:'home',results:null,selected:null,map:null})">
        ← Back
      </button>
      <div>
        <div class="results-title"><strong>Grid Assessment</strong> Complete</div>
        <div class="label" style="margin-top:4px">
          ${results.transformersFound} transformers · ${results.solarForecast} kW solar · ${results.searchRadius} m radius
        </div>
      </div>
      <div class="results-meta">${new Date(results.timestamp).toLocaleTimeString()}</div>
    </div>

    <div class="stats-row">
      <div class="stat-tile">
        <div class="stat-tile-val">${results.transformersFound}</div>
        <div class="stat-tile-lbl">Transformers Found</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-val ${topScore >= 80 ? 'green' : topScore >= 50 ? 'amber' : 'red'}">${topScore.toFixed(1)}</div>
        <div class="stat-tile-lbl">Top Score /100</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-val green">${supported}</div>
        <div class="stat-tile-lbl">Can Support</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-val">${results.solarForecast} kW</div>
        <div class="stat-tile-lbl">Solar Capacity</div>
      </div>
      <div class="stat-tile">
        <div class="stat-tile-val amber">${results.transformers.filter(t => t.curtailmentRisk).length}</div>
        <div class="stat-tile-lbl">Curtailment Risk</div>
      </div>
    </div>

    <div style="padding: 0 32px 24px; max-width:1280px; margin:0 auto">
      <div class="map-card">
        <div class="map-card-header">
          <span class="map-card-title mono">TRANSFORMER MAP</span>
          <div class="map-legend">
            <div class="legend-item"><div class="legend-dot" style="background:#10b981"></div>IDEAL</div>
            <div class="legend-item"><div class="legend-dot" style="background:#00d4ff"></div>GOOD</div>
            <div class="legend-item"><div class="legend-dot" style="background:#f59e0b"></div>FAIR</div>
            <div class="legend-item"><div class="legend-dot" style="background:#ef4444"></div>POOR</div>
            <div class="legend-item"><div class="legend-dot" style="background:#00d4ff;border:2px solid #0a0e1a"></div>YOU</div>
          </div>
        </div>
        <div id="resultsMap"></div>
      </div>
    </div>

    <div class="results-grid">
      <!-- LEFT: list + chart -->
      <div>
        <div class="tf-section-title">Ranked Transformers</div>
        ${results.transformers.map(tf => renderTFCard(tf)).join('')}

        <!-- Score sub-dimension chart -->
        <div class="chart-card" style="margin-top:8px">
          <div class="chart-card-title">Score Breakdown — Top 5 Transformers</div>
          <canvas id="scoreChart" height="140"></canvas>
        </div>
      </div>

      <!-- RIGHT: detail panel -->
      <div>
        <div class="detail-panel">
          ${selected ? renderDetailPanel(selected) : renderDetailEmpty()}
        </div>
      </div>
    </div>
  `;
}

function renderTFCard(tf) {
  const isActive = state.selected && state.selected.code === tf.code;
  const col = scoreColor(tf.score);
  return `
    <div class="tf-card ${isActive ? 'active' : ''}" onclick="selectTF(${JSON.stringify(tf).replace(/"/g,'&quot;')})">
      <div class="tf-rank">
        <div class="tf-rank-num">${tf.rank}</div>
        <div style="font-size:9px;margin-top:2px;font-family:var(--mono)">RANK</div>
      </div>

      <div>
        <div style="display:flex;align-items:center;gap:10px">
          <span class="tf-code">${tf.code}</span>
          <span class="dist-pill">${tf.distance.toFixed(0)} m</span>
          ${tf.curtailmentRisk ? `<span class="dist-pill" style="border-color:rgba(239,68,68,0.4);color:#fca5a5">⚡ CURTAIL</span>` : ''}
        </div>
        <div class="tf-cluster">${tf.cluster}</div>
        <div class="tf-metrics">
          <div class="tf-metric">
            <div class="tf-metric-lbl">CAPACITY</div>
            <div class="tf-metric-val">${tf.capacity} kW</div>
          </div>
          <div class="tf-metric">
            <div class="tf-metric-lbl">LOAD</div>
            <div class="tf-metric-val">${tf.currentLoad.toFixed(1)} kW</div>
          </div>
          <div class="tf-metric">
            <div class="tf-metric-lbl">HEADROOM</div>
            <div class="tf-metric-val">${tf.availableHeadroom.toFixed(1)} kW</div>
          </div>
          <div class="tf-metric">
            <div class="tf-metric-lbl">UTIL AFTER</div>
            <div class="tf-metric-val" style="color:${utilColor(tf.utilizationAfter)}">${tf.utilizationAfter.toFixed(1)}%</div>
          </div>
        </div>
      </div>

      <div class="tf-badge">
        ${scoreRing(tf.score)}
        <div class="score-label" style="color:${col}">${tf.suitabilityLabel}</div>
        <div style="font-size:10px;color:${tf.canSupport ? '#10b981':'#ef4444'};font-family:var(--mono);margin-top:2px">
          ${tf.canSupport ? '✓ OK' : '✗ NO'}
        </div>
      </div>
    </div>
  `;
}

function renderDetailPanel(tf) {
  const col = scoreColor(tf.score);
  return `
    <div class="detail-code">${tf.code}</div>
    <div class="detail-cluster">${tf.cluster} · Rank #${tf.rank}</div>

    <div class="detail-score-big">
      <div class="detail-score-val" style="color:${col}">${tf.score.toFixed(1)}</div>
      <div class="detail-score-lbl">BLENDED SUITABILITY SCORE / 100</div>
    </div>

    <!-- Sub-scores -->
    <div class="score-sub-grid">
      <div class="score-sub">
        <div class="score-sub-lbl">HEADROOM</div>
        <div class="score-sub-val" style="color:var(--accent)">${tf.headroomScore.toFixed(0)}</div>
      </div>
      <div class="score-sub">
        <div class="score-sub-lbl">DISTANCE</div>
        <div class="score-sub-val" style="color:var(--accent)">${tf.distanceScore.toFixed(0)}</div>
      </div>
      <div class="score-sub">
        <div class="score-sub-lbl">STABILITY</div>
        <div class="score-sub-val" style="color:var(--accent)">${tf.stabilityScore.toFixed(0)}</div>
      </div>
    </div>

    <!-- Rule vs ML -->
    <div class="detail-row">
      <div class="detail-metric">
        <div class="detail-metric-lbl">RULE SCORE</div>
        <div class="detail-metric-val" style="color:#7c3aed">${tf.ruleBasedScore.toFixed(1)}</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">ML SCORE</div>
        <div class="detail-metric-val" style="color:#00d4ff">${tf.mlScore.toFixed(1)}</div>
      </div>
    </div>

    <!-- Utilisation bars -->
    ${utilBar('UTILISATION BEFORE', tf.utilizationBefore)}
    ${utilBar('UTILISATION AFTER', tf.utilizationAfter)}

    <!-- Metrics -->
    <div class="detail-row">
      <div class="detail-metric">
        <div class="detail-metric-lbl">DISTANCE</div>
        <div class="detail-metric-val">${tf.distance.toFixed(0)} m</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">CAPACITY</div>
        <div class="detail-metric-val">${tf.capacity} kW</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">AVAILABLE</div>
        <div class="detail-metric-val">${tf.availableHeadroom.toFixed(1)} kW</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">SAFE HEADROOM</div>
        <div class="detail-metric-val">${tf.safeHeadroom.toFixed(1)} kW</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">EXISTING SOLAR</div>
        <div class="detail-metric-val">${tf.existingSolar.toFixed(1)} kW</div>
      </div>
      <div class="detail-metric">
        <div class="detail-metric-lbl">LOAD +12M</div>
        <div class="detail-metric-val">${tf.futureLoad12m.toFixed(1)} kW</div>
      </div>
    </div>

    <!-- Flags -->
    ${tf.canSupport
      ? `<div class="flag-badge flag-green">✓ &nbsp;Transformer can support ${tf.newSolar} kW</div>`
      : `<div class="flag-badge flag-red">✗ &nbsp;Insufficient capacity for ${tf.newSolar} kW</div>`}
    ${tf.curtailmentRisk
      ? `<div class="flag-badge flag-red">⚡ &nbsp;Curtailment risk — utilisation &gt; 75%</div>`
      : ''}

    <!-- Recommendation -->
    <div style="font-family:var(--mono);font-size:10px;letter-spacing:0.12em;color:var(--muted);margin-bottom:8px;margin-top:8px">RECOMMENDATION</div>
    <div class="rec-box">${tf.recommendation}</div>
  `;
}

function renderDetailEmpty() {
  return `
    <div class="detail-empty">
      <div class="detail-empty-icon">◎</div>
      <div class="detail-empty-txt">Select a transformer<br>to view detailed analysis</div>
    </div>
  `;
}

// ── Chart ────────────────────────────────────────────────────────────────────
let chartInstance = null;
function buildChart() {
  const canvas = document.getElementById('scoreChart');
  if (!canvas || !state.results) return;
  if (chartInstance) { chartInstance.destroy(); chartInstance = null; }

  const top5 = state.results.transformers.slice(0, 5);
  chartInstance = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels: top5.map(t => t.code),
      datasets: [
        {
          label: 'Headroom',
          data: top5.map(t => t.headroomScore),
          backgroundColor: '#7c3aed',
          borderRadius: 3,
        },
        {
          label: 'Distance',
          data: top5.map(t => t.distanceScore),
          backgroundColor: '#00d4ff',
          borderRadius: 3,
        },
        {
          label: 'Stability',
          data: top5.map(t => t.stabilityScore),
          backgroundColor: '#10b981',
          borderRadius: 3,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { labels: { color: '#64748b', font: { family: 'Space Mono', size: 10 } } },
      },
      scales: {
        x: {
          stacked: false,
          ticks: { color: '#64748b', font: { family: 'Space Mono', size: 10 } },
          grid: { color: '#1f2d45' },
        },
        y: {
          max: 100,
          ticks: { color: '#64748b', font: { family: 'Space Mono', size: 10 } },
          grid: { color: '#1f2d45' },
        },
      },
    },
  });
}

// ── Interactions ─────────────────────────────────────────────────────────────
function selectTF(tf) {
  setState({ selected: tf });
}

// ── Render ────────────────────────────────────────────────────────────────────
function render() {
  document.getElementById('app').innerHTML =
    state.page === 'home' ? renderHome() : renderResults();

  if (state.page === 'results') {
    requestAnimationFrame(() => {
      buildChart();
      // Re-init map only if not already present
      if (!state.map) initMap();
    });
  }
}

// ── Boot ──────────────────────────────────────────────────────────────────────
render();

// Health check
fetch(`${API}/api/health`)
  .then(r => r.json())
  .then(d => console.log('✓ API ready:', d))
  .catch(() => console.warn('⚠ API not reachable — start app.py'));
</script>
</body>
</html>