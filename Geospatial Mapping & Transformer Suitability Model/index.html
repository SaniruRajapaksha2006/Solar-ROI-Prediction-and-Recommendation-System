<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Transformer Intelligence System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-accent {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .card-glow {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .metric-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 16px;
            border-radius: 8px;
        }
        #resultsMap {
            height: 500px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }
        .transformer-card {
            background: white;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid #667eea;
        }
        .transformer-card:hover {
            box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }
        .score-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }
        .input-group {
            position: relative;
        }
        .input-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 14px;
        }
        .input-with-icon {
            padding-left: 36px !important;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        const API_URL = 'http://localhost:5000';

        class SolarAssessmentApp {
            constructor() {
                this.state = {
                    currentPage: 'home',
                    userLocation: null,
                    latitude: 6.9271,
                    longitude: 80.7789,
                    solarCapacity: 5.0,
                    searchRadius: 500,
                    loading: false,
                    results: null,
                    selectedTransformer: null,
                    error: null,
                    map: null,
                    transformerMarkers: {}
                };
            }

            setState(updates) {
                this.state = { ...this.state, ...updates };
                this.render();
            }

            async handleAssess() {
                const { latitude, longitude, solarCapacity, searchRadius } = this.state;

                if (!latitude || !longitude) {
                    this.setState({ error: 'Please enter latitude and longitude coordinates' });
                    return;
                }

                this.setState({ loading: true, error: null });

                try {
                    const response = await fetch(`${API_URL}/api/assess`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            latitude,
                            longitude,
                            solarCapacity,
                            searchRadius
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error);
                    }

                    const data = await response.json();
                    this.setState({
                        results: data,
                        currentPage: 'results',
                        loading: false
                    });

                    setTimeout(() => this.initializeResultsMap(), 100);
                } catch (error) {
                    this.setState({
                        error: `Error: ${error.message}`,
                        loading: false
                    });
                }
            }

            initializeResultsMap() {
                if (this.state.map) {
                    this.state.map.remove();
                }

                const { results } = this.state;
                const { latitude, longitude } = this.state;
                const map = L.map('resultsMap').setView([latitude, longitude], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                L.circleMarker([latitude, longitude], {
                    radius: 10,
                    fillColor: '#f5576c',
                    color: 'white',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(map)
                .bindPopup('<strong>Your Location</strong>')
                .openPopup();

                results.transformers.forEach((tf) => {
                    const color = this.getScoreColor(tf.score);
                    const marker = L.circleMarker([tf.latitude, tf.longitude], {
                        radius: 8,
                        fillColor: color,
                        color: 'white',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.7
                    }).addTo(map)
                    .bindPopup(`
                        <div style="font-size: 12px;">
                            <strong>${tf.code}</strong><br/>
                            Score: ${tf.score.toFixed(1)}/100<br/>
                            Distance: ${tf.distance.toFixed(0)}m<br/>
                            Utilization: ${tf.utilizationAfter.toFixed(1)}%<br/>
                            Status: ${tf.canSupport ? '✓ Supported' : '✗ Not Supported'}
                        </div>
                    `);

                    marker.on('click', () => {
                        this.setState({ selectedTransformer: tf });
                    });

                    this.state.transformerMarkers[tf.code] = marker;
                });

                const group = new L.featureGroup(Object.values(this.state.transformerMarkers));
                if (Object.keys(this.state.transformerMarkers).length > 0) {
                    map.fitBounds(group.getBounds().pad(0.1));
                }

                this.setState({ map });
            }

            getScoreColor(score) {
                if (score >= 80) return '#10b981';
                if (score >= 50) return '#f59e0b';
                return '#ef4444';
            }

            getSuitabilityBg(score) {
                if (score >= 80) return 'bg-emerald-50 border-emerald-200';
                if (score >= 50) return 'bg-amber-50 border-amber-200';
                return 'bg-red-50 border-red-200';
            }

            renderHome() {
                return `
                    <div class="gradient-header text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-16">
                            <h1 class="text-5xl font-bold mb-4">Solar Transformer Intelligence</h1>
                            <p class="text-xl text-blue-100">AI-Powered Geospatial Analysis for Optimal Solar Integration</p>
                        </div>
                    </div>

                    <div class="max-w-2xl mx-auto px-6 py-16">
                        <div class="bg-white rounded-xl shadow-lg p-8 card-glow">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">
                                <i class="fas fa-sliders-h mr-2 text-indigo-500"></i>Assessment Parameters
                            </h2>
                            <p class="text-sm text-gray-500 mb-8">Enter your location coordinates and solar setup details to find the best transformer connection.</p>

                            <div class="space-y-5">

                                <!-- Location Section -->
                                <div>
                                    <p class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-3">Location Coordinates</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                Latitude
                                            </label>
                                            <div class="input-group">
                                                <i class="fas fa-map-pin input-icon"></i>
                                                <input
                                                    type="number"
                                                    value="${this.state.latitude}"
                                                    onchange="window.app.setState({latitude: parseFloat(this.value)})"
                                                    step="0.0001"
                                                    placeholder="e.g. 6.9271"
                                                    class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition text-sm"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                Longitude
                                            </label>
                                            <div class="input-group">
                                                <i class="fas fa-map-pin input-icon"></i>
                                                <input
                                                    type="number"
                                                    value="${this.state.longitude}"
                                                    onchange="window.app.setState({longitude: parseFloat(this.value)})"
                                                    step="0.0001"
                                                    placeholder="e.g. 80.7789"
                                                    class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition text-sm"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <hr class="border-gray-100"/>

                                <!-- Solar & Search Section -->
                                <div>
                                    <p class="text-xs font-bold uppercase tracking-widest text-indigo-400 mb-3">Solar & Search Settings</p>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                Solar Capacity (kW)
                                            </label>
                                            <div class="input-group">
                                                <i class="fas fa-bolt input-icon"></i>
                                                <input
                                                    type="number"
                                                    value="${this.state.solarCapacity}"
                                                    onchange="window.app.setState({solarCapacity: parseFloat(this.value)})"
                                                    step="0.5" min="1" max="50"
                                                    class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition text-sm"
                                                />
                                            </div>
                                        </div>
                                        <div>
                                            <label class="block text-sm font-semibold text-gray-700 mb-2">
                                                Search Radius (m)
                                            </label>
                                            <div class="input-group">
                                                <i class="fas fa-circle-notch input-icon"></i>
                                                <input
                                                    type="number"
                                                    value="${this.state.searchRadius}"
                                                    onchange="window.app.setState({searchRadius: parseFloat(this.value)})"
                                                    step="100" min="100" max="2000"
                                                    class="input-with-icon w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-indigo-500 focus:outline-none transition text-sm"
                                                />
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                ${this.state.error ? `
                                    <div class="bg-red-50 border-l-4 border-red-500 text-red-800 p-3 text-sm rounded">
                                        <i class="fas fa-exclamation-circle mr-2"></i>${this.state.error}
                                    </div>
                                ` : ''}

                                <button
                                    onclick="window.app.handleAssess()"
                                    ${this.state.loading ? 'disabled' : ''}
                                    class="w-full gradient-accent text-white py-4 rounded-lg font-bold text-lg hover:shadow-lg transition disabled:opacity-50 disabled:cursor-not-allowed mt-2"
                                >
                                    ${this.state.loading
                                        ? '<div class="flex items-center justify-center gap-3"><div class="loader" style="width:24px;height:24px;border-width:3px;"></div>Assessing...</div>'
                                        : '<i class="fas fa-search mr-2"></i>Run Assessment'
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResults() {
                if (!this.state.results) return '';

                const { results, selectedTransformer } = this.state;

                return `
                    <div class="gradient-header text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-8">
                            <button onclick="window.app.setState({currentPage: 'home', map: null, transformerMarkers: {}})" class="mb-4 text-blue-100 hover:text-white transition">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Home
                            </button>
                            <h1 class="text-4xl font-bold">Assessment Results</h1>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                            <div class="stat-card">
                                <div class="stat-value">${results.transformersFound}</div>
                                <div class="stat-label">Transformers Found</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${results.solarForecast}</div>
                                <div class="stat-label">Solar Capacity (kW)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">${results.searchRadius}</div>
                                <div class="stat-label">Search Radius (m)</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" style="background: linear-gradient(135deg, #10b981, #059669); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                    ${results.transformers[0].score.toFixed(1)}
                                </div>
                                <div class="stat-label">Top Score</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">
                                    ${results.transformers.filter(t => t.canSupport).length}/${results.transformersFound}
                                </div>
                                <div class="stat-label">Supported</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-lg p-6 card-glow mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-4">
                                <i class="fas fa-map-marked-alt mr-2"></i>Transformer Locations
                            </h2>
                            <div id="resultsMap"></div>
                        </div>

                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            <div class="lg:col-span-2 space-y-4">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                                    <i class="fas fa-list mr-2"></i>Transformer Rankings
                                </h2>
                                ${results.transformers.map((tf) => `
                                    <div
                                        class="transformer-card ${this.getSuitabilityBg(tf.score)}"
                                        onclick="window.app.setState({selectedTransformer: ${JSON.stringify(tf).replace(/"/g, '&quot;')}})"
                                    >
                                        <div class="flex items-start justify-between gap-4">
                                            <div class="flex-1">
                                                <div class="flex items-center gap-3 mb-2">
                                                    <span class="text-xl font-bold text-gray-600">#${tf.rank}</span>
                                                    <h3 class="text-lg font-bold text-gray-800">${tf.code}</h3>
                                                    <span class="text-xs bg-white px-2 py-1 rounded-full text-gray-600">
                                                        ${tf.distance.toFixed(0)}m away
                                                    </span>
                                                </div>
                                                <p class="text-sm text-gray-600 mb-3">${tf.cluster}</p>
                                                <div class="grid grid-cols-3 gap-2 text-xs">
                                                    <div>
                                                        <span class="text-gray-600">Capacity</span>
                                                        <p class="font-bold">${tf.capacity}kW</p>
                                                    </div>
                                                    <div>
                                                        <span class="text-gray-600">Load</span>
                                                        <p class="font-bold">${tf.currentLoad.toFixed(1)}kW</p>
                                                    </div>
                                                    <div>
                                                        <span class="text-gray-600">After</span>
                                                        <p class="font-bold" style="color: ${tf.utilizationAfter > 85 ? '#ef4444' : '#10b981'}">
                                                            ${tf.utilizationAfter.toFixed(1)}%
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="flex flex-col items-center gap-2">
                                                <div class="score-badge" style="background: ${this.getScoreColor(tf.score)}">
                                                    ${tf.score.toFixed(0)}
                                                </div>
                                                <span class="text-xs font-semibold text-center" style="color: ${this.getScoreColor(tf.score)}">
                                                    ${tf.score >= 80 ? 'IDEAL' : tf.score >= 50 ? 'GOOD' : 'FAIR'}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="lg:col-span-1">
                                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                                    <i class="fas fa-info-circle mr-2"></i>Details
                                </h2>
                                ${selectedTransformer ? `
                                    <div class="bg-white rounded-xl shadow-lg p-6 card-glow space-y-4">
                                        <h3 class="text-xl font-bold text-gray-800">${selectedTransformer.code}</h3>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Overall Score</p>
                                            <p class="text-2xl font-bold" style="color: ${this.getScoreColor(selectedTransformer.score)}">
                                                ${selectedTransformer.score.toFixed(1)}/100
                                            </p>
                                        </div>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Distance</p>
                                            <p class="text-xl font-bold">${selectedTransformer.distance.toFixed(0)}m</p>
                                        </div>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Utilization Before</p>
                                            <p class="text-xl font-bold">${selectedTransformer.utilizationBefore.toFixed(1)}%</p>
                                        </div>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Utilization After</p>
                                            <p class="text-xl font-bold" style="color: ${selectedTransformer.utilizationAfter > 85 ? '#ef4444' : '#10b981'}">
                                                ${selectedTransformer.utilizationAfter.toFixed(1)}%
                                            </p>
                                        </div>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Future Load (12m)</p>
                                            <p class="text-xl font-bold">${selectedTransformer.futureLoad12m.toFixed(2)}kW</p>
                                        </div>

                                        <div class="metric-box">
                                            <p class="text-sm text-gray-600 mb-1">Support Status</p>
                                            <p class="text-lg font-bold">
                                                ${selectedTransformer.canSupport ?
                                                    '<span style="color: #10b981">✓ Supported</span>' :
                                                    '<span style="color: #ef4444">✗ Not Supported</span>'
                                                }
                                            </p>
                                        </div>

                                        ${selectedTransformer.curtailmentRisk ? `
                                            <div class="bg-red-50 border border-red-200 p-3 rounded text-red-800 text-sm">
                                                <i class="fas fa-warning mr-2"></i>Curtailment Risk
                                            </div>
                                        ` : ''}

                                        <div class="bg-gray-50 border border-gray-200 p-3 rounded text-sm">
                                            <p class="font-semibold text-gray-800 mb-1">Recommendation</p>
                                            <p class="text-gray-700">${selectedTransformer.recommendation}</p>
                                        </div>

                                        <div class="grid grid-cols-2 gap-2 text-xs">
                                            <div class="bg-blue-50 p-2 rounded">
                                                <span class="text-gray-600">Rule Score</span>
                                                <p class="font-bold text-blue-600">${selectedTransformer.ruleBasedScore.toFixed(1)}</p>
                                            </div>
                                            <div class="bg-purple-50 p-2 rounded">
                                                <span class="text-gray-600">ML Score</span>
                                                <p class="font-bold text-purple-600">${selectedTransformer.mlScore.toFixed(1)}</p>
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-6 text-center">
                                        <i class="fas fa-mouse-pointer text-3xl text-gray-400 mb-2"></i>
                                        <p class="text-gray-600">Click on a transformer to view details</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                `;
            }

            render() {
                const { currentPage } = this.state;
                document.getElementById('app').innerHTML = currentPage === 'home' ? this.renderHome() : this.renderResults();
            }
        }

        const app = new SolarAssessmentApp();
        window.app = app;
        app.render();

        fetch(`${API_URL}/api/health`)
            .then(res => res.json())
            .then(data => console.log('✓ API connected:', data))
            .catch(err => console.warn('⚠ API not available:', err));
    </script>
</body>
</html>