<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solar Transformer Intelligence System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .gradient-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-accent {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .card-glow {
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.2);
        }
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid white;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .feature-badge {
            display: inline-block;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            margin-right: 8px;
            margin-bottom: 8px;
        }
        .metric-box {
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            border-left: 4px solid #667eea;
            padding: 16px;
            border-radius: 8px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        const API_URL = 'http://localhost:5000';

        class SolarAssessmentApp {
            constructor() {
                this.state = {
                    currentPage: 'home', // home, assessment, results, analytics
                    location: '6.848917321,79.92456012',
                    solarCapacity: 5.0,
                    searchRadius: 500,
                    loading: false,
                    results: null,
                    analytics: null,
                    featureImportance: null,
                    clustering: null,
                    selectedTransformer: null,
                    activeTab: 'overview',
                    error: null
                };
                this.charts = {};
            }

            setState(updates) {
                this.state = { ...this.state, ...updates };
                this.render();
            }

            async fetchAnalytics() {
                try {
                    const [importance, clustering] = await Promise.all([
                        fetch(`${API_URL}/api/feature-importance`).then(r => r.json()),
                        fetch(`${API_URL}/api/clustering`).then(r => r.json())
                    ]);

                    this.setState({
                        featureImportance: importance,
                        clustering: clustering
                    });
                } catch (error) {
                    console.error('Error fetching analytics:', error);
                }
            }

            async handleAssess() {
                const { location, solarCapacity, searchRadius } = this.state;

                if (!location.trim()) {
                    this.setState({ error: 'Please enter a location' });
                    return;
                }

                this.setState({ loading: true, error: null });

                try {
                    const response = await fetch(`${API_URL}/api/assess`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ location, solarCapacity, searchRadius })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error);
                    }

                    const data = await response.json();
                    this.setState({
                        results: data,
                        currentPage: 'results',
                        activeTab: 'overview',
                        loading: false
                    });

                    // Fetch analytics
                    await this.fetchAnalytics();
                } catch (error) {
                    this.setState({
                        error: `Error: ${error.message}`,
                        loading: false
                    });
                }
            }

            getSuitabilityColor(score) {
                if (score >= 80) return '#10b981';
                if (score >= 50) return '#f59e0b';
                return '#ef4444';
            }

            getSuitabilityBg(score) {
                if (score >= 80) return 'bg-emerald-50 border-emerald-200';
                if (score >= 50) return 'bg-amber-50 border-amber-200';
                return 'bg-red-50 border-red-200';
            }

            renderHome() {
                return `
                    <div class="gradient-header text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-16">
                            <h1 class="text-5xl font-bold mb-4">Solar Transformer Intelligence</h1>
                            <p class="text-xl text-blue-100">AI-Powered Geospatial Analysis for Optimal Solar Integration</p>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-6 py-12">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                            <div class="bg-white rounded-xl shadow-lg p-8 card-glow">
                                <h2 class="text-2xl font-bold text-gray-800 mb-6">üéØ Assessment</h2>
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i class="fas fa-map-pin mr-2"></i>Location (Lat, Lon)
                                        </label>
                                        <input
                                            type="text"
                                            value="${this.state.location}"
                                            onchange="window.app.setState({location: this.value})"
                                            placeholder="6.849, 79.925"
                                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i class="fas fa-bolt mr-2"></i>Solar Capacity (kW)
                                        </label>
                                        <input
                                            type="number"
                                            value="${this.state.solarCapacity}"
                                            onchange="window.app.setState({solarCapacity: parseFloat(this.value)})"
                                            step="0.5" min="1" max="50"
                                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                        />
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-gray-700 mb-2">
                                            <i class="fas fa-circle-notch mr-2"></i>Search Radius (m)
                                        </label>
                                        <input
                                            type="number"
                                            value="${this.state.searchRadius}"
                                            onchange="window.app.setState({searchRadius: parseFloat(this.value)})"
                                            step="100" min="100" max="2000"
                                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-blue-600 focus:outline-none"
                                        />
                                    </div>

                                    ${this.state.error ? `
                                        <div class="bg-red-100 border-l-4 border-red-600 text-red-800 p-3">
                                            <i class="fas fa-exclamation-circle mr-2"></i>${this.state.error}
                                        </div>
                                    ` : ''}

                                    <button
                                        onclick="window.app.handleAssess()"
                                        ${this.state.loading ? 'disabled' : ''}
                                        class="w-full gradient-accent text-white py-3 rounded-lg font-bold hover:shadow-lg transition disabled:opacity-50"
                                    >
                                        ${this.state.loading ? '<div class="flex items-center justify-center gap-2"><div class="loader"></div>Assessing...</div>' : 'Run Assessment'}
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div class="bg-white rounded-xl shadow-lg p-6 card-glow">
                                    <h3 class="font-bold text-lg mb-4">‚ú® AI Features</h3>
                                    <div class="space-y-2 text-sm">
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-brain text-blue-600 mt-1"></i>
                                            <span><strong>ML Prediction:</strong> Random Forest-based suitability scoring</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-circle-nodes text-green-600 mt-1"></i>
                                            <span><strong>Clustering:</strong> Automatic transformer grouping</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-chart-line text-purple-600 mt-1"></i>
                                            <span><strong>Load Forecast:</strong> 12-month future predictions</span>
                                        </div>
                                        <div class="flex items-start gap-2">
                                            <i class="fas fa-lightbulb text-yellow-600 mt-1"></i>
                                            <span><strong>Explainability:</strong> Feature importance analysis</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="bg-white rounded-xl shadow-lg p-6 card-glow">
                                    <h3 class="font-bold text-lg mb-4">üìä System Components</h3>
                                    <div class="space-y-2 text-xs">
                                        <div><span class="feature-badge">Geospatial</span></div>
                                        <div><span class="feature-badge">Capacity Analysis</span></div>
                                        <div><span class="feature-badge">Rule-Based Scoring</span></div>
                                        <div><span class="feature-badge">ML Prediction</span></div>
                                        <div><span class="feature-badge">Load Forecasting</span></div>
                                        <div><span class="feature-badge">XAI Explainability</span></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderResults() {
                if (!this.state.results) return '';

                const { results, activeTab } = this.state;
                const { transformers } = results;

                return `
                    <div class="gradient-header text-white shadow-lg">
                        <div class="max-w-7xl mx-auto px-6 py-8">
                            <button onclick="window.app.setState({currentPage: 'home'})" class="mb-4 text-blue-100 hover:text-white">
                                <i class="fas fa-arrow-left mr-2"></i>Back to Home
                            </button>
                            <h1 class="text-4xl font-bold">Assessment Results</h1>
                        </div>
                    </div>

                    <div class="max-w-7xl mx-auto px-6 py-8">
                        <!-- Summary -->
                        <div class="bg-white rounded-xl shadow-lg p-8 card-glow mb-8">
                            <h2 class="text-2xl font-bold text-gray-800 mb-6">üìä Summary</h2>
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <div class="metric-box">
                                    <p class="text-sm text-gray-600 mb-1">Location</p>
                                    <p class="font-bold text-gray-800">${results.userLocation}</p>
                                </div>
                                <div class="metric-box">
                                    <p class="text-sm text-gray-600 mb-1">Solar Capacity</p>
                                    <p class="font-bold text-gray-800">${results.solarForecast} kW</p>
                                </div>
                                <div class="metric-box">
                                    <p class="text-sm text-gray-600 mb-1">Transformers Found</p>
                                    <p class="font-bold text-gray-800">${transformers.length}</p>
                                </div>
                                <div class="metric-box">
                                    <p class="text-sm text-gray-600 mb-1">Top Score</p>
                                    <p class="font-bold text-gray-800" style="color: ${this.getSuitabilityColor(transformers[0].score)}">${transformers[0].score.toFixed(1)}/100</p>
                                </div>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="bg-white rounded-xl shadow-lg overflow-hidden card-glow">
                            <div class="flex border-b border-gray-200 flex-wrap">
                                ${['overview', 'ml-scores', 'clustering', 'forecast', 'explainability'].map(tab => `
                                    <button
                                        onclick="window.app.setState({activeTab: '${tab}'})"
                                        class="px-6 py-4 font-semibold transition ${
                                            activeTab === tab
                                                ? 'gradient-accent text-white'
                                                : 'text-gray-700 hover:bg-gray-50'
                                        }"
                                    >
                                        ${tab === 'overview' ? 'üéØ Overview' :
                                          tab === 'ml-scores' ? 'ü§ñ ML Scores' :
                                          tab === 'clustering' ? '‚≠ê Clustering' :
                                          tab === 'forecast' ? 'üìà Forecast' :
                                          tab === 'explainability' ? 'üí° XAI' : tab}
                                    </button>
                                `).join('')}
                            </div>

                            <div class="p-8">
                                ${activeTab === 'overview' ? this.renderOverviewTab(transformers) : ''}
                                ${activeTab === 'ml-scores' ? this.renderMLScoresTab(transformers) : ''}
                                ${activeTab === 'clustering' ? this.renderClusteringTab() : ''}
                                ${activeTab === 'forecast' ? this.renderForecastTab(transformers) : ''}
                                ${activeTab === 'explainability' ? this.renderExplainabilityTab() : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderOverviewTab(transformers) {
                return transformers.map((tf, idx) => `
                    <div class="border-2 rounded-lg p-6 transition mb-6 ${this.getSuitabilityBg(tf.score)}">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">#${tf.rank} - ${tf.code}</h3>
                                <p class="text-gray-600"><i class="fas fa-map-marker-alt mr-2"></i>${tf.distance.toFixed(1)}m away</p>
                                <p class="text-gray-600 text-sm"><i class="fas fa-tag mr-2"></i>Cluster: ${tf.cluster}</p>
                            </div>
                            <div class="text-center">
                                <div class="inline-block bg-white rounded-full p-4 shadow">
                                    <p class="text-3xl font-bold" style="color: ${this.getSuitabilityColor(tf.score)}">${tf.score.toFixed(1)}</p>
                                    <p class="text-xs text-gray-600">Final Score</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-4 text-sm">
                            <div class="bg-white p-3 rounded">
                                <p class="text-gray-600 text-xs">Capacity</p>
                                <p class="font-bold">${tf.capacity} kW</p>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <p class="text-gray-600 text-xs">Load</p>
                                <p class="font-bold">${tf.currentLoad.toFixed(1)} kW</p>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <p class="text-gray-600 text-xs">Before</p>
                                <p class="font-bold">${tf.utilizationBefore.toFixed(1)}%</p>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <p class="text-gray-600 text-xs">After</p>
                                <p class="font-bold" style="color: ${tf.utilizationAfter > 85 ? '#ef4444' : '#10b981'}">${tf.utilizationAfter.toFixed(1)}%</p>
                            </div>
                            <div class="bg-white p-3 rounded">
                                <p class="text-gray-600 text-xs">Future (12m)</p>
                                <p class="font-bold">${tf.futureLoad12m.toFixed(1)} kW</p>
                            </div>
                        </div>

                        <div class="flex flex-wrap gap-2 mb-4">
                            ${tf.canSupport ? `<span class="bg-emerald-100 text-emerald-800 px-3 py-1 rounded-full text-sm font-semibold"><i class="fas fa-check-circle mr-1"></i>Supported</span>` : ''}
                            ${tf.curtailmentRisk ? `<span class="bg-red-100 text-red-800 px-3 py-1 rounded-full text-sm font-semibold"><i class="fas fa-warning mr-1"></i>Risk</span>` : ''}
                        </div>

                        <p class="text-sm font-semibold text-gray-700 p-3 bg-white rounded border-l-4" style="border-color: ${this.getSuitabilityColor(tf.score)}">
                            ${tf.recommendation}
                        </p>
                    </div>
                `).join('');
            }

            renderMLScoresTab(transformers) {
                return `
                    <div class="space-y-6">
                        <p class="text-gray-600"><i class="fas fa-info-circle mr-2"></i>Blended score combines Rule-Based (50%) + ML Prediction (50%)</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm">
                                <thead>
                                    <tr class="bg-gray-100 border-b-2">
                                        <th class="px-4 py-3 text-left font-bold">Transformer</th>
                                        <th class="px-4 py-3 text-center font-bold">Rule-Based</th>
                                        <th class="px-4 py-3 text-center font-bold">ML Score</th>
                                        <th class="px-4 py-3 text-center font-bold">Blended</th>
                                        <th class="px-4 py-3 text-center font-bold">Confidence</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${transformers.map(tf => `
                                        <tr class="border-b hover:bg-gray-50">
                                            <td class="px-4 py-3 font-bold">${tf.code}</td>
                                            <td class="px-4 py-3 text-center">
                                                <span style="color: ${this.getSuitabilityColor(tf.ruleBasedScore)}" class="font-bold">${tf.ruleBasedScore.toFixed(1)}</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span style="color: ${this.getSuitabilityColor(tf.mlScore)}" class="font-bold">${tf.mlScore.toFixed(1)}</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <span style="color: ${this.getSuitabilityColor(tf.score)}" class="font-bold">${tf.score.toFixed(1)}</span>
                                            </td>
                                            <td class="px-4 py-3 text-center">
                                                <div class="w-16 h-2 bg-gray-300 rounded-full mx-auto">
                                                    <div class="h-2 rounded-full" style="width: ${tf.mlScore}%; background-color: ${this.getSuitabilityColor(tf.mlScore)}"></div>
                                                </div>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            renderClusteringTab() {
                if (!this.state.clustering) return '<p>Loading clustering analysis...</p>';

                const clustering = this.state.clustering;
                return `
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        ${Object.entries(clustering).map(([clusterName, data]) => `
                            <div class="bg-gradient-to-br from-blue-50 to-purple-50 border-2 border-blue-200 rounded-lg p-6">
                                <h3 class="font-bold text-lg mb-4">‚≠ê ${clusterName}</h3>
                                <div class="space-y-3 text-sm">
                                    <div class="flex justify-between">
                                        <span>Count:</span>
                                        <span class="font-bold">${data.count}</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Avg Utilization:</span>
                                        <span class="font-bold">${data.avgUtilization.toFixed(1)}%</span>
                                    </div>
                                    <div class="flex justify-between">
                                        <span>Solar Penetration:</span>
                                        <span class="font-bold">${data.avgSolarPenetration.toFixed(1)}%</span>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderForecastTab(transformers) {
                return `
                    <p class="text-gray-600 mb-6"><i class="fas fa-chart-line mr-2"></i>12-month load forecast showing growth trajectory</p>
                    <div class="space-y-6">
                        ${transformers.slice(0, 3).map((tf, idx) => `
                            <div class="border rounded-lg p-4">
                                <h4 class="font-bold mb-3">${tf.code} - Current Load: ${tf.currentLoad.toFixed(2)} kW ‚Üí Future: ${tf.futureLoad12m.toFixed(2)} kW</h4>
                                <div class="w-full bg-gray-200 rounded-full h-3">
                                    <div class="bg-gradient-accent h-3 rounded-full" style="width: ${Math.min((tf.futureLoad12m / tf.capacity) * 100, 100)}%"></div>
                                </div>
                                <p class="text-sm text-gray-600 mt-2">Growth: ${((tf.futureLoad12m / tf.currentLoad - 1) * 100).toFixed(1)}%</p>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderExplainabilityTab() {
                if (!this.state.featureImportance) return '<p>Loading feature importance...</p>';

                const importance = this.state.featureImportance.features;
                const topFeatures = Object.entries(importance).slice(0, 6);

                return `
                    <div class="space-y-6">
                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                            <p class="text-sm text-gray-700">
                                <i class="fas fa-lightbulb mr-2"></i>
                                <strong>Feature Importance Analysis:</strong> Shows which factors most influence suitability predictions
                            </p>
                        </div>

                        <div class="space-y-3">
                            ${topFeatures.map(([feature, importance]) => `
                                <div>
                                    <div class="flex justify-between mb-1">
                                        <span class="font-semibold text-gray-800">${feature}</span>
                                        <span class="text-blue-600 font-bold">${(importance * 100).toFixed(1)}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3">
                                        <div class="gradient-accent h-3 rounded-full" style="width: ${importance * 100}%"></div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>

                        <div class="bg-purple-50 p-4 rounded-lg border border-purple-200 mt-6">
                            <h4 class="font-bold mb-2">üéØ Interpretation</h4>
                            <p class="text-sm text-gray-700">
                                The model uses multiple features to determine suitability. Higher importance indicates stronger influence on final recommendations. This transparency helps validate and understand AI decisions.
                            </p>
                        </div>
                    </div>
                `;
            }

            render() {
                const { currentPage } = this.state;

                const html = `
                    ${currentPage === 'home' ? this.renderHome() : this.renderResults()}
                `;

                document.getElementById('app').innerHTML = html;
            }
        }

        // Initialize app
        const app = new SolarAssessmentApp();
        window.app = app;
        app.render();

        // Check API health
        fetch(`${API_URL}/api/health`)
            .then(res => res.json())
            .then(data => console.log('‚úì API connected:', data))
            .catch(err => console.warn('‚ö† API not available:', err));
    </script>
</body>
</html>